<html>

<head>
    <script type="text/javascript" src="./src/constants.js"></script>
    <script type="text/javascript" src="./src/compare-arrangements.js"></script>
</head>

<body>
    <h2>Try to find new arrangments</h2>    
    <div id="container">
        <div id='result-zone'>
            <svg id="zone" height="1" width="1" style="border:1px solid #d8d8d8"></svg> 
            <div id="footer-container">
                <div id="export-svg">
                    <button id="load-arr">Load arrangments</button>              
                    <button id="test-current-arr">Test current arr</button>
                    <!-- 
                    <div class='import-export-container'>                     
                        <button id="export-selection-btn">Export</button>   
                    </div>
                    <button id="save-squares-btn">Save current object</button> 
                    -->                                
                </div>
                <div id='matrices'>          
                    <div class="header">
                        <div class="column-result">V</div>
                        <div class="column-result">F</div>
                    </div>
                    <div class="body">
                        <div class="column-result" id="v-matrix">
                            <div class="line-matrix-group">
                                <div class="line-matrix">
                                    <div class="m-square border-left border-top"></div>
                                    <div id="v00" class="m-square">0</div>
                                    <div id="v01" class="m-square">0</div>
                                    <div id="v02" class="m-square">0</div>
                                    <div class="m-square border-right border-top"></div>
                                </div>
                                <div class="line-matrix"> 
                                    <div class="m-square border-left"></div>
                                    <div id="v10" class="m-square">0</div>
                                    <div id="v11" class="m-square">0</div>
                                    <div id="v12" class="m-square">0</div>
                                    <div class="m-square border-right"></div>
                                </div>                            
                                <div class="line-matrix">
                                    <div class="m-square border-left border-bottom"></div>
                                    <div id="v20" class="m-square">0</div>
                                    <div id="v21" class="m-square">0</div>
                                    <div id="v22" class="m-square">0</div>
                                    <div class="m-square border-right border-bottom"></div>
                                </div>                                  
                            </div> 
                            <div id="v-illegal">illegal!</div>                         
                        </div>
                        <div class="column-result" id="f-matrix">
                            <div class="line-matrix-group">
                                <div class="line-matrix">
                                    <div class="m-square border-left border-top"></div>
                                    <div id="f00" class="m-square">0</div>
                                    <div id="f01" class="m-square">0</div>
                                    <div id="f02" class="m-square">0</div>                                 
                                    <div class="m-square border-right border-top"></div>
                                </div>
                                <div class="line-matrix"> 
                                    <div class="m-square border-left"></div>
                                    <div id="f10" class="m-square">0</div>
                                    <div id="f11" class="m-square">0</div>
                                    <div id="f12" class="m-square">0</div>                                 
                                    <div class="m-square border-right"></div>
                                </div>    
                                <div class="line-matrix"> 
                                    <div class="m-square border-left"></div>
                                    <div id="f20" class="m-square">0</div>
                                    <div id="f21" class="m-square">0</div>
                                    <div id="f22" class="m-square">0</div>                                 
                                    <div class="m-square border-right"></div>
                                </div>                           
                                <div class="line-matrix">
                                    <div class="m-square border-left border-bottom"></div>
                                    <div id="f30" class="m-square">0</div>
                                    <div id="f31" class="m-square">0</div>
                                    <div id="f32" class="m-square">0</div>                                
                                    <div class="m-square border-right border-bottom"></div>
                                </div>                                  
                            </div> 
                            <div id="f-illegal">illegal!</div>                                 
                        </div>
                    </div>                                      
                </div>  
            </div>   
        </div>     
        <div>
            <div class='line' id='active-square'>
                <p>Active square: </p>
                <div class="radio-button">
                    <div class="radio-button"> 
                        <label>0</label>           
                        <input type="radio" name="square-selected" value="0" checked>
                        <label>1</label>   
                        <input type="radio" name="square-selected" value="1" >
                        <label>2</label>   
                        <input type="radio" name="square-selected" value="2" >
                    </div>
                </div>
            </div>
            <div class='line' id="translate">
               <p>Translate (pixel)</p>
               <button id="go-up">&uarr;</button>
               <div class="form-group">  
                    <button id="go-left">&larr;</button>
                    <div id="column">
                        <div>
                            <input type="text" id="translation-step" name="translation-step" min="1" max="50" value='10' >
                        </div>
                        <div class="small-btn-container">
                            <div class="small-button" id='decrease-translation-step'>-</div>       
                            <div class="small-button" id='increase-translation-step'>+</div>       
                        </div>
                    </div>
                    <button id="go-right">&rarr;</button>
               </div>
               <button id="go-down">&darr;</button>
            </div>
            <div class='line' id="rotate">
                <p>Rotate (degres)</p>
                <div class="form-group">  
                    <button id="rotate-moins" class='flip' >&#8635;</button>
                    <div class="column">
                        <div>
                            <input type="text" id="rotation-step" name="rotation-step" value='10' >
                        </div>
                        <div class="small-btn-container">
                            <div class="small-button" id='decrease-rotation-step'>-</div>       
                            <div class="small-button" id='increase-rotation-step'>+</div>                 
                        </div>
                    </div>   
                    <button id="rotate-plus">&#8635;</button> 
                </div>
            </div>
            <div class='line' id="resize">
                    <p>Resize (pixel)</p>
                    <div class="form-group">  
                        <button id="resize-moins">-</button>
                        <div class="column">
                            <div>
                                <input id="resize-step" type="text" name="resize-step" min="1" max="300" value='10' >
                            </div>
                            <div class="small-btn-container">
                                <div class="small-button" id='decrease-resize-step'>-</div>                      
                                <div class="small-button" id='increase-resize-step'>+</div>                 
                            </div>
                        </div>                
                        <button id="resize-plus">+</button>
                    </div>            
            </div>
        </div>
    </div>

    <script type="module">

        //idee optimisation: pre calculer tous les gabari de carres (avec scales et rotations) puis les translater
        import { createSVGSquare, updateSVGSquare, drawPoint, drawBox, saveSvg, squareStyle, createSvgArr } from './draw.js';
        const { W, H, NB_SQUARE, NB_VERTEX} = constants;
        const are_VI_Equivalents = compareArrangments.are_VI_Equivalents;
        const arrangement_to_VI = calculVI.arrangement_to_VI;
        const getInitSquares = initSquares.getInitSquares;
        var squares = getInitSquares(constants);

        let arrangments = [];    
        let nbArr;

        let currentArr = 0;
        let currV = [ 
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0]
        ];
        let currI = [
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0],
            [0, 0, 0]
        ];
        var squares = getInitSquares(constants);

        //List of arrangments that we will select and export to use later in a simulation
        //contains center, vertices and size (a), boxes will be recalculaed later
        //var arrangmentsSelection = [];

        var svg = document.getElementsByTagName('svg')[0]; //Get svg element
        svg.setAttribute('width','500px');
        svg.setAttribute('height','353px');

        var exportIndex = 0; 
        var selectedSquare = 0;
        var translationStep = 5;
        var rotationStep = 5;
        var resizeStep = 5;

        //Update the displayed matrice according to the value of the squares object
        var updateMatrices = function(){
            let arr = arrangement_to_VI(squares, NB_VERTEX);
            let V = arr.V;
            let I = arr.I;
            if (arr.valid) {
                document.getElementById('v-illegal').style.display = "none";
                document.getElementById('f-illegal').style.display = "none";
                for(let i=0;i<3;i++){
                    for(let j=0;j<3;j++){
                        document.getElementById('v'+i+j).innerHTML = V[i][j];
                    }                 
                }
                for(let i=0;i<4;i++){
                    for(let j=0;j<3;j++){
                        document.getElementById('f'+i+j).innerHTML = I[i][j];
                    }                 
                }
            } else {
                document.getElementById('v-illegal').style.display = "block";
                document.getElementById('f-illegal').style.display = "block";
                for(let i=0;i<3;i++){
                    for(let j=0;j<3;j++){
                        document.getElementById('v'+i+j).innerHTML = '.';
                    }                 
                }
                for(let i=0;i<4;i++){
                    for(let j=0;j<3;j++){
                        document.getElementById('f'+i+j).innerHTML = '.';
                    }                 
                }
            }
            testCurrentArrangment();
        }

        //Define event when click a radio button
        var radio = document.getElementsByName('square-selected');
        for (var i = 0; i < radio.length; i++) {
            radio[i].addEventListener('change', function(event) { 
                selectedSquare = event.target.value;
                console.log(selectedSquare);
                document.getElementById('square0').style.strokeWidth = '0.5';
                document.getElementById('square1').style.strokeWidth = '0.5';
                document.getElementById('square2').style.strokeWidth = '0.5';
                document.getElementById('square'+selectedSquare).style.strokeWidth = 2;
            });
        }

        //Define event when click a svg square
        document.addEventListener("DOMContentLoaded", function() {
            ['square0','square1','square2',].map((square)=>{
                document.getElementById(square).addEventListener('click', function(event) { 
                    selectedSquare = event.target.id.split("square")[1];
                    document.getElementById('square0').style.strokeWidth = '0.5';
                    document.getElementById('square1').style.strokeWidth = '0.5';
                    document.getElementById('square2').style.strokeWidth = '0.5';
                    document.getElementById('square'+selectedSquare).style.strokeWidth = 2;
                });
            })
        });


        //tranlation step
        document.getElementById('translation-step').addEventListener('change', function(event) { 
            translationStep = event.target.value;
        });
        document.getElementById('increase-translation-step').addEventListener('click', function(event) {
            let elem = document.getElementById('translation-step');
            elem.value = parseInt(elem.value) + 1;
            translationStep = elem.value;
        });
        document.getElementById('decrease-translation-step').addEventListener('click', function(event) {
            let elem = document.getElementById('translation-step');
            elem.value = parseInt(elem.value) - 1;
            if ( elem.value < 0 ){ elem.value = 0; }
            translationStep = elem.value;
        });
        document.getElementById('go-up').addEventListener('click', function(event) {
            let sq = squares[selectedSquare];
            sq.translate({x:0, y: -parseInt(translationStep)}, true);
            updateSVGSquare(sq,selectedSquare);
            updateMatrices();
        });
        document.getElementById('go-down').addEventListener('click', function(event) {
            let sq = squares[selectedSquare];
            sq.translate({x:0, y: parseInt(translationStep)}, true);
            updateSVGSquare(sq,selectedSquare);
            updateMatrices();  
        });
        document.getElementById('go-left').addEventListener('click', function(event) {
            let sq = squares[selectedSquare];
            sq.translate({x: -parseInt(translationStep), y: 0}, true);
            updateSVGSquare(sq,selectedSquare);   
            updateMatrices();
        });
        document.getElementById('go-right').addEventListener('click', function(event) {
            let sq = squares[selectedSquare];
            sq.translate({x: parseInt(translationStep), y: 0}, true);
            updateSVGSquare(sq, selectedSquare);   
            updateMatrices();
        });

        //Rotation events
        document.getElementById('rotation-step').addEventListener('change', function(event) { 
            rotationStep = event.target.value;
        });
        document.getElementById('increase-rotation-step').addEventListener('click', function(event) {
            let elem = document.getElementById('rotation-step');
            elem.value = parseInt(elem.value) + 1;
            rotationStep = elem.value;
        });
        document.getElementById('decrease-rotation-step').addEventListener('click', function(event) {
            let elem = document.getElementById('rotation-step');
            elem.value = parseInt(elem.value) - 1;
            if ( elem.value < 0 ){ elem.value = 0; }
            rotationStep = elem.value;
        });
        document.getElementById('rotate-plus').addEventListener('click', function(event) {
            let sq = squares[selectedSquare];
            sq.angle = sq.angle + parseInt(rotationStep);
            sq.rotate(sq.angle, true);
            updateSVGSquare(sq, selectedSquare);   
            updateMatrices();
        });
        document.getElementById('rotate-moins').addEventListener('click', function(event) {
            let sq = squares[selectedSquare];
            sq.angle = sq.angle - parseInt(rotationStep);
            sq.rotate(sq.angle, true);
            updateSVGSquare(sq, selectedSquare);   
            updateMatrices();
        });


        //Resize events
        document.getElementById('resize-step').addEventListener('change', function(event) { 
            resizeStep = event.target.value;
        });
        document.getElementById('increase-resize-step').addEventListener('click', function(event) {
            let elem = document.getElementById('resize-step');
            elem.value = parseInt(elem.value) + 1;
            resizeStep = elem.value;
        });
        document.getElementById('decrease-resize-step').addEventListener('click', function(event) {
            let elem = document.getElementById('resize-step');
            elem.value = parseInt(elem.value) - 1;
            if ( elem.value < 0 ){ elem.value = 0; }
            resizeStep = elem.value;
        });
        document.getElementById('resize-plus').addEventListener('click', function(event) {
            let sq = squares[selectedSquare];
            let a = sq.a + parseInt(resizeStep);
            sq.changeSize(a, true);
            updateSVGSquare(sq,selectedSquare);
            updateMatrices();
        });
        document.getElementById('resize-moins').addEventListener('click', function(event) {
            let sq = squares[selectedSquare];
            let a = sq.a - parseInt(resizeStep);
            sq.changeSize(a, true);
            updateSVGSquare(sq, selectedSquare);
            updateMatrices();
        });

        var testCurrentArrangment = ()=>{
            let arr = arrangement_to_VI(squares, NB_VERTEX);
            if ( arr.valid ){
                let found = false;
                let n = arrangments.length;
                for (let i=0;i<n;i++){              
                    if (are_VI_Equivalents(arrangments[i], arr) ) {
                        found = true;
                        break;
                    }
                }
                if (!found && n > 0){
                    alert('new arrangment !');
                } else {
                    console.log('not new...');
                }
            } else {
                console.log('Illegal!');
            }
        }


        document.getElementById('test-current-arr').addEventListener('click', function(event) {          
            testCurrentArrangment();
        });

        //Charge l'arrangement i: upadate squares objet with it and update displayed svg
        function loadArr(i){
            //createSvgArr();         
            let arr = arrangments[i];
            let label = [];
            for (let j=0;j<3;j++){
                //debugger;
                let polygon = document.getElementById('square'+j);
                let points = "";
                for(let k=0;k<4;k++){
                    points += arr.squares[j].vertex[k].x + ',' +arr.squares[j].vertex[k].y + ' ';
                }
                polygon.setAttribute("points",points); 
                polygon.style = squareStyle[j]; 
                label[j] = document.getElementById('label'+j);                     
                label[j].setAttributeNS(null, 'x', arr.squares[j].center.x-5);
                label[j].setAttributeNS(null, 'y', arr.squares[j].center.y+5);
                
                //mettre Ã  jour l'objet squares local 
                squares[j].copy2(arr.squares[j]);
                squares[j].majBox();
                updateMatrices();
            }         
        };

        //Charge les arrangements contenus dans le fichier json 
        //et affiche le premier d'entre eux 
        document.getElementById('load-arr').addEventListener('click', function(event) {
            fetch('http://localhost:8080/src/save_result/arrangments-found-4337-31-32.json')
            .then(response => response.text())
            .then((data) => { 
                arrangments = JSON.parse(data);
                nbArr = arrangments.length;
                currentArr = 0;
                loadArr(currentArr);
            });
        });


        //on place les squares dans la zone
        //squares[0].initRotZero(100, {x:W/2-110, y:H/2-110});

        squares[0].initRotZero(100, {x:W/2 - 150, y:H/2 - 110});
        squares[0].majBox();
        createSVGSquare(squares[0],0);
        document.getElementById('square0').style.strokeWidth = 2;

        //Les deux autres squares vont bouger
        squares[1].initRotZero(100, {x:W/2 - 20, y:H/2});
        squares[1].majBox();
        //squares[1].translate({x:W/2, y:H/2})
        createSVGSquare(squares[1],1);

        squares[2].initRotZero(100, {x:W/2 + 110, y:H/2 - 110});
        squares[2].majBox();
        //squares[1].translate({x:W/2, y:H/2})
        createSVGSquare(squares[2],2);

        // document.getElementById('export-arrs-btn').addEventListener('click', (event) => {
        //     let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(arrangments));
        //     let dlAnchorElem = document.getElementById('downloadAnchorElem');
        //     var downloadLink = document.createElement("a");
        //     document.body.appendChild(downloadLink);
        //     document.body.removeChild(downloadLink);
        //     downloadLink.setAttribute("href",dataStr);
        //     let fileName = "arr-selection-"+Date.now()+".json";
        //     console.log(fileName);
        //     downloadLink.setAttribute("download",fileName);
        //     downloadLink.click();
        // });
       
        // document.getElementById('import-selection-btn').addEventListener('click', (event) => {
        //     fetch('arr-selection-1565085578378.json')
        //     .then(response => response.text())
        //     .then((text) => { 
        //         console.log(text);
        //         arrangmentsSelection = JSON.parse(text);
        //         debugger;
        //     })
        // });

        //save square object button
        // document.getElementById('save-squares-btn').addEventListener('click', (event) => {
        //     let _squares = JSON.parse(JSON.stringify(squares));
        //     //const _squares = Object.assign([], squares);
        //     //_squares.pop();//remove the third square which is not used
        //     arrangmentsSelection.push(_squares);
        //     console.log(arrangmentsSelection);
        // });

    </script>
    <script type="text/javascript" src="./src/calculVI.js"></script>
    <script type="text/javascript" src="./src/initSquares.js"></script>
<style>   
    #container {
        display:flex;
        flex-direction: row;
        justify-content: center;
    }
    #translate, #rotate, #resize {
        display: flex;
        flex-direction: column;
        justify-content: space-evenly;
        align-items: center;
    }
    button {
        width: 44px;
        height:44px;
        font-size: 1.2em;
        cursor:pointer;
    }
    input {
        width: 44px;
        font-size: 1.1em;
        text-align: center;
        height: 22px;
    }
    .radio-button {
        display: flex;
        flex-direction: row;
        justify-content: space-evenly;
        align-items: center;
        padding-left: 10px;
    }
    #active-square{
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .line {
        border: 1px solid #d8d8d8;
        padding: 14px;
    }
    .flip{
        transform: scale(-1, 1);
    }
    .column{
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .small-button{
        width: 20px;
        height:20px;
        border: 1px solid #b9b9b9;
        text-align: center;
        cursor:pointer;
    }
    .small-btn-container{
        display: flex;
        flex-direction: row;
    }
    .form-group {
        display:flex;
    }
    p {
        margin: 0 0 10px 0;
    }
    #result-zone{
        display: flex;
        flex-direction: column;
        justify-content: space-evenly;
        align-items: center;
    }
    h2 {
        text-align: center;
    }
    #footer-container{
        display: flex;
        justify-content: space-around;
        align-items: center;
        border: 1px solid #d8d8d8;
        width: 500px;
        height: 140px;
    }
    #export-svg {
        width: 50%;
        height: 100%;
        display: flex;
        justify-content: space-around;
        align-items: center;
        border-right:1px solid #d8d8d8;
        flex-direction: column;
    }
    #test-current-arr, #save-squares-btn, #load-arr {
        width: 155px;
        height: 30px;
        font-size: 0.8em;
    }
    #import-export-container{
        display:flex;
        flex-direction: column;
    }
    #import-selection-btn, #export-selection-btn{
        width: 76px;
        height: 30px;
        font-size: 0.8em;
    }
    #matrices{
        width: 80%;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .column-result{
        width:50%;
        border: 1px solid #d8d8d8;
        display: flex;
        justify-content: center;
    }
    .header{
        display: flex;
        flex-direction: row;
    }
    .body{
        display: flex;
        flex-direction: row;
    }
    .line-matrix-group{
        margin:6px;
    }
    .line-matrix {
        display: flex;
        flex-direction: row;
    }
    .m-square{
        padding: 2px 5px;
    }
    .border-left{
        border-left: 1px solid black;
        padding: 2px 3px;
    }
    .border-right{
        border-right: 1px solid black;
        padding: 2px 3px;
    }
    .border-top{
        border-top: 1px solid black;
    }
    .border-bottom{
        border-bottom: 1px solid black;
    }
    #v-illegal, #f-illegal{
        position: relative;
        left: -60px;
        top: 30px;
        display:none;
    }
    #square0, #square1 , #square2{
        cursor: pointer;
    }

    .nav{
        display:flex;
    }

</style>
</body>
</html>
