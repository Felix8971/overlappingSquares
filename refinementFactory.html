<html>

<head>
    <script type="text/javascript" src="./src/constants.js"></script>
    <script type="text/javascript" src="./controlEvents.js"></script>
    <script type="text/javascript" src="./src/compare-arrangements.js"></script>
    <script type="text/javascript" src="./src/calculVI.js"></script>
    <script type="text/javascript" src="./src/initSquares.js"></script>

    <script type="text/javascript" src="raphael.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h2>Refinement tool 3 squares overlapping</h2>  
    
    <div class="container">
        <p>This page presents the arrangments possible for 3 overlapping squares.</p>
        <p>Two arrangements of N squares are considered the same if one can be continuously changed to the other without any vertex passing through an edge</p>
        <p>V(i,j) = number of vertices from the square i included in the square j</p>>
        <p>F(i,j) = number intersections found on the segment jfor square i</p>>
    </div>

    <div class="container">
        <div id='result-zone'>
            <div id="msg">Invalid move</div>
            <div id="new-arr">New arrangment !</div>
            <div id="slide-container">
                <input class="custom-slider" type="range" value="50">
            </div>
            <div id="btn-control">
                <div id="play-pause-btn">
                    <img id="play-btn" src="./images/play-button.svg" width="30" height="30" alt="Play" title="Play">   
                    <img id="pause-btn" src="./images/pause-button.svg" width="30" height="30" alt="Pause" title="Pause">                  
                </div>    
                <div id="stop-btn">
                    <img id="stop-btn" src="./images/stop-button.svg" width="30" height="30" alt="Stop" title="Stop">                 
                </div>   
                <div id="previous-btn">
                    <img src="./images/next-button.svg" width="30" height="30" alt="Previous" title="Previous">                 
                </div> 
                <div id="next-btn">
                    <img src="./images/next-button.svg" width="30" height="30" alt="Next" title="Next">                 
                </div>  
                <div id="zoom-out-btn">
                    <img id="zoom-out-btn" src="./images/zoom-out-button.svg" width="35" height="35" alt="Zoom-out" title="Zoom-out">                 
                </div>  
                <div id="zoom-in-btn">
                    <img src="./images/zoom-in-button.svg" width="35" height="35" alt="Zoom-in" title="Zoom-in">  
                </div>     
            </div>

            <div id="legend">
                <div class="legend-line">
                    <div class="line-0"></div>
                    <div class="value">0</div>
                </div>
                <div class="legend-line">
                    <div class="line-1"></div>
                    <div class="value">1</div>
                </div>
                <div class="legend-line">
                    <div class="line-2"></div>
                    <div class="value">2</div>
                </div>
            </div>
            <div id="nb-arr-container">Total arrangments:
                <span id="nbArr"></span>
            </div>   
            <div id="current-arr-container">Current arrangment:
                <input id="current-arr" type="text" name="current-arr"  value='1' >
            </div>

            <div id='matrices'>          
                <div class="header">
                    <div class="column-result">V</div>
                    <div class="column-result">F</div>
                </div>
                <div class="body">
                    <div class="column-result" id="v-matrix">
                        <div class="line-matrix-group">
                            <div class="line-matrix">
                                <div class="m-square border-left border-top"></div>
                                <div id="v00" class="m-square">0</div>
                                <div id="v01" class="m-square">0</div>
                                <div id="v02" class="m-square">0</div>
                                <div class="m-square border-right border-top"></div>
                            </div>
                            <div class="line-matrix"> 
                                <div class="m-square border-left"></div>
                                <div id="v10" class="m-square">0</div>
                                <div id="v11" class="m-square">0</div>
                                <div id="v12" class="m-square">0</div>
                                <div class="m-square border-right"></div>
                            </div>                            
                            <div class="line-matrix">
                                <div class="m-square border-left border-bottom"></div>
                                <div id="v20" class="m-square">0</div>
                                <div id="v21" class="m-square">0</div>
                                <div id="v22" class="m-square">0</div>
                                <div class="m-square border-right border-bottom"></div>
                            </div>                                  
                        </div> 
                        <div id="v-illegal">illegal!</div>                         
                    </div>
                    <div class="column-result" id="f-matrix">
                        <div class="line-matrix-group">
                            <div class="line-matrix">
                                <div class="m-square border-left border-top"></div>
                                <div id="f00" class="m-square">0</div>
                                <div id="f01" class="m-square">0</div>
                                <div id="f02" class="m-square">0</div>                                 
                                <div class="m-square border-right border-top"></div>
                            </div>
                            <div class="line-matrix"> 
                                <div class="m-square border-left"></div>
                                <div id="f10" class="m-square">0</div>
                                <div id="f11" class="m-square">0</div>
                                <div id="f12" class="m-square">0</div>                                 
                                <div class="m-square border-right"></div>
                            </div>    
                            <div class="line-matrix"> 
                                <div class="m-square border-left"></div>
                                <div id="f20" class="m-square">0</div>
                                <div id="f21" class="m-square">0</div>
                                <div id="f22" class="m-square">0</div>                                 
                                <div class="m-square border-right"></div>
                            </div>                           
                            <div class="line-matrix">
                                <div class="m-square border-left border-bottom"></div>
                                <div id="f30" class="m-square">0</div>
                                <div id="f31" class="m-square">0</div>
                                <div id="f32" class="m-square">0</div>                                
                                <div class="m-square border-right border-bottom"></div>
                            </div>                                  
                        </div> 
                        <div id="f-illegal">illegal!</div>                                 
                    </div>
                </div>                                      
            </div>   
            
        </div>     
        <div>
            <div class='line' id='active-square'>
                <p>Active square: </p>
                <div class="radio-button">
                    <div class="radio-button"> 
                        <label>0</label>           
                        <input type="radio" name="square-selected" value="0" checked>
                        <label>1</label>   
                        <input type="radio" name="square-selected" value="1" >
                        <label>2</label>   
                        <input type="radio" name="square-selected" value="2" >
                    </div>
                </div>
            </div>
            <div class='line' id="translate">
               <p>Translate (pixel)</p>
               <button id="go-up">&uarr;</button>
               <div class="form-group">  
                    <button id="go-left">&larr;</button>
                    <div id="column">
                        <div>
                            <input type="text" id="translation-step" name="translation-step" min="1" max="50" value='1' >
                        </div>
                        <div class="small-btn-container">
                            <div class="small-button" id='decrease-translation-step'>-</div>       
                            <div class="small-button" id='increase-translation-step'>+</div>       
                        </div>
                    </div>
                    <button id="go-right">&rarr;</button>
               </div>
               <button id="go-down">&darr;</button>
            </div>
            <div class='line' id="rotate">
                <p>Rotate (degres)</p>
                <div class="form-group">  
                    <button id="rotate-moins" class='flip' >&#8635;</button>
                    <div class="column">
                        <div>
                            <input type="text" id="rotation-step" name="rotation-step" value='1' >
                        </div>
                        <div class="small-btn-container">
                            <div class="small-button" id='decrease-rotation-step'>-</div>       
                            <div class="small-button" id='increase-rotation-step'>+</div>                 
                        </div>
                    </div>   
                    <button id="rotate-plus">&#8635;</button> 
                </div>
            </div>
            <div class='line' id="resize">
                    <p>Resize (pixel)</p>
                    <div class="form-group">  
                        <button id="resize-moins">-</button>
                        <div class="column">
                            <div>
                                <input id="resize-step" type="text" name="resize-step" min="1" max="300" value='1' >
                            </div>
                            <div class="small-btn-container">
                                <div class="small-button" id='decrease-resize-step'>-</div>                      
                                <div class="small-button" id='increase-resize-step'>+</div>                 
                            </div>
                        </div>                
                        <button id="resize-plus">+</button>
                    </div>            
            </div>
            <div class='line'>
                <button id="update-json">Update json</button>                         
            </div>
        </div>
    </div>
    <div style="opacity: 0;">Icons made by <a href="https://www.flaticon.com/authors/smashicons" title="Smashicons">Smashicons</a> from <a href="https://www.flaticon.com/"  title="Flaticon">www.flaticon.com</a></div>

    <script type="module">

        //idee optimisation: pre calculer tous les gabari de carres (avec scales et rotations) puis les translater
        import { fadeOut, updateSVGSquare } from './draw.js';
       
        const { W, H, NB_SQUARE, NB_VERTEX, } = constants;
        const { _controlEvents } = controlEvents;
        const are_VI_Equivalents = compareArrangments.are_VI_Equivalents;
        const arrangement_to_VI = calculVI.arrangement_to_VI;
        const getInitSquares = initSquares.getInitSquares;
        const zoomStep = W/20;

        let arrangments = [];
        let nbArr = null;
        var ANIMATION_DURATION = 200;
        
        //Update the displayed matrices according to the value of the squares object
        var updateMatrices = function(arr){          
            let V = arr.V;
            let I = arr.I;
            if (arr.valid) {
                document.getElementById('v-illegal').style.display = "none";
                document.getElementById('f-illegal').style.display = "none";
                for(let i=0;i<3;i++){
                    for(let j=0;j<3;j++){
                        document.getElementById('v'+i+j).innerHTML = V[i][j];
                    }                 
                }
                for(let i=0;i<4;i++){
                    for(let j=0;j<3;j++){
                        document.getElementById('f'+i+j).innerHTML = I[i][j];
                    }                 
                }
            } else {
                document.getElementById('v-illegal').style.display = "block";
                document.getElementById('f-illegal').style.display = "block";
                for(let i=0;i<3;i++){
                    for(let j=0;j<3;j++){
                        document.getElementById('v'+i+j).innerHTML = '.';
                    }                 
                }
                for(let i=0;i<4;i++){
                    for(let j=0;j<3;j++){
                        document.getElementById('f'+i+j).innerHTML = '.';
                    }                 
                }
            }
            testCurrentArrangment(arr);
        }

       
        var testCurrentArrangment = (arr)=>{
            if ( arr.valid ){
                let found = false;
                let index = null;
                let n = arrangments.length;
                for (let i=0;i<n;i++){              
                    if (are_VI_Equivalents(arrangments[i], arr) ) {
                        found = true;
                        index = i + 1;
                        break;
                    }
                }
                if (!found && n > 0){
                    //alert('new arrangment !');
                    console.log('new !');
                    document.getElementById('new-arr').innerHTML = "new arrangment !";
                    document.getElementById('current-arr').value = null;
                    document.getElementById('new-arr').style.opacity = 1;

                    let newArr = {
                        V: arr.V,
                        I: arr.I,
                        squares: [
                            {
                                a: arr.squares[0].a,
                                center: arr.squares[0].center,
                                angle: arr.squares[0].angle,
                            },
                            {
                                a: arr.squares[1].a,
                                center: arr.squares[1].center,
                                angle: arr.squares[1].angle,
                            },
                            {
                                a: arr.squares[2].a,
                                center: arr.squares[2].center,
                                angle: arr.squares[2].angle,
                            },               
                        ],
                    };

                    debugger;
                    arrangments.push(newArr);
                    
                    console.log(JSON.stringify(newArr));

                } else {
                    console.log('not new...');
                    document.getElementById('new-arr').innerHTML = "";
                    _controlEvents.setCurrentArr(index-1); 
                    document.getElementById('current-arr').value = index;
                    document.getElementById('new-arr').style.opacity = 1;
                }
            } else {
                console.log('Illegal!');
            }
        }

        let mode = 'lock';//'unlocked';

        var validMove = function(sq, callback){
            //calcul nouvelle matrices V et I pour cette position
            let arr = arrangement_to_VI(squares, NB_VERTEX, NB_SQUARE);
            let index = _controlEvents.getSelectedSquareIndex();
            if ( mode == 'unlocked' ){// unlocked mode: we can chanage the current arrangment
                if (arr.valid){
                    let x = sq.center.x - 0.5*sq.a;
                    let y = sq.center.y - 0.5*sq.a;
                    sq.svg.animate({
                        x,
                        y,
                        width: sq.a,
                        height: sq.a,
                        transform: "r"+sq.angle,
                        delay: 1000
                    }, ANIMATION_DURATION);
                   
                    // console.log(sq.angle);
                    // sq.svg.attr({
                    //     x, 
                    //     y, 
                    //     width: sq.a, 
                    //     height: sq.a,
                    //     transform: "r"+sq.angle,
                    // });

                    updateMatrices(arr);
                    
                } else {
                    //Reverse the modification  
                    callback(sq);             
                }
                
            } else { // locked mode: we cannot chanage the current arrangment
                if (arr.valid && are_VI_Equivalents(arrangments[_controlEvents.getCurrentArr()], arr) ) {
                    //updateSVGSquare(sq, selectedSquareIndex);
                    //and we update the svg square  
                    let x = sq.center.x - 0.5*sq.a;
                    let y = sq.center.y - 0.5*sq.a;
                    squares[index].svg.animate({ 
                        x,
                        y,
                        width: sq.a,
                        height: sq.a,
                        transform: "r"+sq.angle,
                        delay: 1000
                    }, ANIMATION_DURATION); 

                    // Mettre a jour arrangments[currentArr] pour pouvoir exporter la modif plus tard
                    let square = arrangments[_controlEvents.getCurrentArr()].squares[index];
                    square.a = sq.a; //edge length
                    square.center.x = sq.center.x;
                    square.center.y = sq.center.y;
                    square.angle = sq.angle; 
                    square.vertex = [];
                    for (let i=0;i<NB_VERTEX;i++){
                        square.vertex[i] = {};
                        square.vertex[i].x = sq.vertex[i].x; 
                        square.vertex[i].y = sq.vertex[i].y;  
                    } 
                } else {
                    //Reverse the modification  
                    callback(sq);             
                }
            }
        }

        // document.getElementById('export_new_arr').addEventListener('click', function(event) {
        //     //{"V":[[0,0,0],[2,0,0],[0,0,0]],"I":[[3,4,4],[4,4,4],[3,2,4],[2,2,4]],"squares":[{"a":94,"center":{"x":250,"y":250},"angle":0},{"a":118,"center":{"x":222.5,"y":242.5},"angle":20},{"a":118,"center":{"x":242.5,"y":247.5},"angle":50}]}
        //     JSON.stringify(arrsLigth);
        // });

        document.getElementById('update-json').addEventListener('click', function(event) {
            let arrsLigth = arrangments.map((elem)=>{
                return {
                    V: elem.V,
                    I: elem.I,
                    squares: [
                        {
                            a: elem.squares[0].a,
                            center: elem.squares[0].center,
                            angle: elem.squares[0].angle,
                            //vertex: elem.squares[0].vertex,
                        },
                        {
                            a: elem.squares[1].a,
                            center: elem.squares[1].center,
                            angle: elem.squares[1].angle,
                            //vertex: elem.squares[1].vertex,
                        },
                        {
                            a: elem.squares[2].a,
                            center: elem.squares[2].center,
                            angle: elem.squares[2].angle,
                            //vertex: elem.squares[2].vertex,
                        },               
                    ],
                }
            });
            let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(arrsLigth));
            let dlAnchorElem = document.getElementById('downloadAnchorElem');
            var downloadLink = document.createElement("a");
            document.body.appendChild(downloadLink);
            document.body.removeChild(downloadLink);
            downloadLink.setAttribute("href",dataStr);
            let fileName = "arrangments-found-"+Date.now()+".json";
            console.log(fileName);
            downloadLink.setAttribute("download",fileName);
            downloadLink.click();
        });

        // function match(elem) {
        //     return ( ( elem.V[0][1] == 0 && elem.V[1][0] == 0 ) 
        //       || ( elem.V[1][2] == 0 && elem.V[2][1] == 0 )
        //       || ( elem.V[0][2] == 0 && elem.V[2][0] == 0 ) 
        //     )
        // }

        function applyZoom(zoomValue){ 
            const xmin = zoomValue * zoomStep;
            const ymin = zoomValue * zoomStep;
            const _w = W - 2 * zoomValue * zoomStep;
            const _h = H - 2 * zoomValue * zoomStep;
            if ( _w > 0 && _h > 0 && _w <= W && _h <= H)
            paper.setViewBox(xmin, ymin, _w, _h);

            for (let k=0;k<3;k++){
                squares[k].svg.attr({'stroke-width': 1 - zoomValue/14});
            }
        }

        // function getArrangmentBox(squares){
        //     let xmin=999, xmax=-999, ymin=999, ymax=-999;
        //     for (let j=0;j<3;j++){
        //         if ( squares[j].box.xmin < xmin ){
        //             xmin = squares[j].box.xmin;                   
        //         }
        //         if ( squares[j].box.ymin < ymin ){
        //             ymin = squares[j].box.ymin;                   
        //         }
        //         if ( squares[j].box.xmax > xmax ){
        //             xmax = squares[j].box.xmax;                   
        //         }
        //         if ( squares[j].box.ymax > ymax ){
        //             ymax = squares[j].box.ymax;           
        //         }
        //     }
        //     return {xmin, xmax, ymin, ymax};
        // }

        //Load arrangement i: update the local squares objet with it and update displayed svg
        function loadArr(i){                
            let arr = arrangments[i];           
            let label = [];
            let xmin=999, xmax=-999, ymin=999, ymax=-999;
            
            for (let j=0;j<3;j++){
                //We apply the geometric parameters of arr.squares[j] to squares[j] 
                squares[j].changeState({
                    x: arr.squares[j].center.x, 
                    y: arr.squares[j].center.y}, 
                    arr.squares[j].a, 
                    arr.squares[j].angle
                );             
                // if ( squares[j].box.xmin < xmin ){
                //     xmin = squares[j].box.xmin;                   
                // }
                // if ( squares[j].box.ymin < ymin ){
                //     ymin = squares[j].box.ymin;                   
                // }
                // if ( squares[j].box.xmax > xmax ){
                //     xmax = squares[j].box.xmax;                   
                // }
                // if ( squares[j].box.ymax > ymax ){
                //     ymax = squares[j].box.ymax;                   
                // }
               
                //and we update the svg square   
                let x = squares[j].center.x - 0.5*squares[j].a;
                let y = squares[j].center.y - 0.5*squares[j].a;
                squares[j].svg.animate({ 
                    x,
                    y,
                    width: squares[j].a,
                    height: squares[j].a,
                    transform: "r"+squares[j].angle,
                }, ANIMATION_DURATION, "ease-in-out"); 

                document.getElementById('current-arr').value = parseInt(i + 1);
                updateMatrices(arrangement_to_VI(squares, NB_VERTEX, NB_SQUARE));
            }   
        };

        function shuffle(a) {
            var j, x, i;
            for (i = a.length - 1; i > 0; i--) {
                j = Math.floor(Math.random() * (i + 1));
                x = a[i];
                a[i] = a[j];
                a[j] = x;
            }
            return a;
        }

        const loadArrangments = (url)=>{
            fetch(url)
            .then(response => response.text())
            .then((data) => {               ;
                arrangments = JSON.parse(data)
                //arrangments = shuffle(JSON.parse(data));    
                //  arrangments = arrangments.filter((elem)=>
                //  (( elem.V[0][1] + elem.V[0][2] == 0 ) && ( elem.I[0][0] + elem.I[1][0] + elem.I[2][0] + elem.I[3][0] == 0 ) ));
                nbArr = arrangments.length;
                
                _controlEvents
                .translationStepEvents()
                .rotationStepEvents()
                .resizeStepEvents()
                .translationEvents(squares, validMove, fadeOut)
                .rotationEvents(squares, validMove, fadeOut)
                .resizeEvents(squares, validMove, fadeOut)
                .radioBtnEvents(squares)
                .arrangmentNavigationEvents(applyZoom, loadArr, nbArr);

                document.getElementById('nbArr').innerHTML = nbArr;
                console.log(nbArr);
                _controlEvents.setCurrentArr(0); //currentArr = 0;
                loadArr(_controlEvents.getCurrentArr());
                _controlEvents.setZoomValue(2); 
                applyZoom(_controlEvents.getZoomValue());
            });
        }

        //contains the current state of our squares
        var squares = getInitSquares(constants);
        
        var paper = Raphael(document.getElementById('result-zone'), W, H); 

        //make a rectangle that fills the whole canvas area
        var rect = paper.rect(0, 0, W, H);

        rect.attr("fill", "black")
        .click(function() {
            _controlEvents.setSelectedSquareIndex(0);
            //selectedSquareIndex = selectedSquareIndex < 2 ? selectedSquareIndex + 1 : 0;         
            for (let k=0;k<3;k++){
                squares[k].svg.attr({"fill-opacity": 0});
            }
            //squares[selectedSquareIndex].svg.attr({"fill-opacity": 0.2});
        });
       
        let squareStyle = [
            {stroke:'#0000FF', fill:"#0000FF"},
            {stroke:'#00ff00', fill:"#00ff00"},
            {stroke:'#ff0000', fill:"#ff0000"},
        ];
        squareStyle = squareStyle.map((elem)=>{
            return {...elem, 'stroke-width': 1, 'fill-opacity':0, 'cursor':'pointer'}          
        });
       
        for (let j=0;j<3;j++){
            squares[j].svg = paper.rect(250, 200, 0, 0).attr(squareStyle[j])
            .click(function(){ //Define event when click a svg square        
                _controlEvents.setSelectedSquareIndex(j);
                for (let k=0;k<3;k++){
                    squares[k].svg.attr({"fill-opacity": 0});
                }
                this.attr({"fill-opacity": 0.3}); 
            });
            
            //add glow effect on hover
            let g;
            squares[j].svg.hover(function() {
                g = squares[j].svg.glow().attr('stroke',squareStyle[j].stroke);
            }, function() {// removing the glow        
                g.remove();
            });
        }
        
        //Load the arrangments from the json file and display the fist one
        loadArrangments('http://localhost:8080/src/result/arrangments-found-4288-0-0.json');

    </script>


</body>
</html>